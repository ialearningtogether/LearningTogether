<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEARNING TOGETHER | Aprendiendo Juntos IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4Cg+aRz/2gqS4p7/r8Z4m5cK5Q8KjA5l5O4n4o4F5d5Rz9xR5xR5t5Q==	" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CR√çTICO: Asegura que los saltos de l√≠nea (\n) se muestren correctamente para el Chat de AURA y Quiz */
        .chat-message-ai p:last-child {
            white-space: pre-wrap; 
        }
        /* Aplicar la fuente Inter a todo el cuerpo */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* CSS personalizado para la imagen de fondo y el efecto Hero */
        #hero {
            /* NOTA: Usar una URL de placeholder para la imagen del profesor, 
               ya que las im√°genes locales no se cargan en este entorno. */
            background-image: url('IA.jpg'); 
            background-size: cover;
            background-position: center;
            /* Se mantiene el filtro oscuro (multiplicar) para que el texto sea legible */
            background-blend-mode: multiply;
            background-color: rgba(0, 0, 0, 0.4); 
        }

        /* Estilo para el bot√≥n flotante del Asistente IA (AURA) */
        #aura-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 100; 
            transition: transform 0.3s ease-in-out;
            width: 70px; 
            height: 70px; 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0; 
            border-radius: 50%;
            background-color: #6d28d9; 
            overflow: hidden; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        
        #aura-button img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            border-radius: 50%;
        }
        #aura-button:hover {
            transform: scale(1.1);
        }
        
        /* Estilo para las secciones de caracter√≠sticas */
        .feature-card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Estilo para la tarjeta de cursos con imagen */
        .course-card img {
            height: 150px; /* Altura fija para la imagen */
            object-fit: cover; /* Asegura que la imagen cubra el √°rea sin distorsionarse */
            border-radius: 0.5rem 0.5rem 0 0; /* Solo bordes superiores redondeados */
        }

        /* Estilo para el modal de Notificaci√≥n/Confirmaci√≥n (Reemplazo de alert/confirm) */
        #notificationModal {
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Estilo para el bot√≥n de registro deshabilitado */
        .btn-registered {
            background-color: #10b981 !important; /* Esmeralda */
            cursor: default;
            pointer-events: none;
        }
        
        /* --- ESTILOS CR√çTICOS DEL CHAT (BURBUJAS) --- */
        .chat-message {
            max-width: 85%; /* Limita el ancho de las burbujas */
            padding: 10px 14px;
            border-radius: 18px;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .chat-message.user {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            align-self: flex-end; /* Alinea a la derecha */
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }
        .chat-message.ai {
            background-color: #ede9fe; /* violet-100 */
            color: #1f2937; /* gray-800 */
            align-self: flex-start; /* Alinea a la izquierda */
            margin-right: auto;
            border-bottom-left-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Secci√≥n de Dashboard (Nuevo: Visible solo cuando el usuario est√° autenticado) -->
    <section id="user-dashboard" class="bg-indigo-700 text-white py-3 px-4 md:px-8 hidden">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center text-sm">
            <div id="welcome-message">
                <i class="fas fa-gem mr-2"></i> ¬°Bienvenido! Tu progreso cuenta.
            </div>
            <div class="flex space-x-6 mt-2 md:mt-0">
                <div class="flex items-center">
                    <i class="fas fa-star text-yellow-300 mr-1"></i> Puntos: <span id="dashboard-points" class="font-bold ml-1">0</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-calendar-check text-green-300 mr-1"></i> Citas Agendadas: <span id="dashboard-appointments" class="font-bold ml-1">0</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Secci√≥n Hero Minimalista -->
    <header id="hero" class="h-screen flex items-center justify-center text-white p-4">
        <div class="text-center max-w-4xl">
            <h1 class="text-5xl md:text-7xl font-extrabold mb-4 animate-pulse">
                Aprendiendo Juntos
            </h1>
            <p class="text-xl md:text-2xl mb-8 font-light">
                Impulsa tu carrera con **Inteligencia Artificial y Tecnolog√≠a** de la mano de expertos.
            </p>

            <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4">
                <!-- ID para identificar el bot√≥n de registro y actualizarlo si ya se registr√≥ -->
                <button id="registerButton" onclick="openModal('registerModal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    <i class="fas fa-user-plus mr-2"></i> Reg√≠strate Ahora
                </button>
                <button onclick="openModal('interestsModal')" class="bg-white text-blue-600 hover:bg-gray-100 font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    <i class="fas fa-search mr-2"></i> Descubre tus Intereses
                </button>
            </div>
        </div>
    </header>

    <!-- Secci√≥n de Caracter√≠sticas Clave (Visi√≥n, Misi√≥n, Contactos) -->
    <section id="features" class="py-16 px-4 md:px-8">
        <h2 class="text-3xl font-bold text-center mb-12 text-gray-800">¬øPor Qu√© Elegir LEARNING TOGETHER?</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">

            <div class="feature-card bg-white p-6 rounded-xl shadow-md text-center border-t-4 border-blue-500">
                <i class="fas fa-lightbulb text-5xl text-blue-600 mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">Nuestra Visi√≥n</h3>
                <p class="text-gray-600">Ser la plataforma l√≠der en educaci√≥n tecnol√≥gica, utilizando la IA como herramienta principal y como objeto de estudio.</p>
            </div>

            <div class="feature-card bg-white p-6 rounded-xl shadow-md text-center border-t-4 border-blue-500">
                <i class="fas fa-rocket text-5xl text-blue-600 mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">Nuestra Misi√≥n</h3>
                <p class="text-gray-600">Democratizar el conocimiento de la IA, haci√©ndolo accesible y aplicable para todos a trav√©s de una experiencia de aprendizaje personalizada.</p>
            </div>

            <div class="feature-card bg-white p-6 rounded-xl shadow-md text-center border-t-4 border-blue-500">
                <i class="fas fa-headset text-5xl text-blue-600 mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">Contacto y Soporte</h3>
                <p class="text-gray-600 mb-4">Agenda una asesor√≠a personalizada o resuelve tus dudas con nuestro equipo.</p>
                <button onclick="openModal('appointmentModal')" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-full transition duration-300">
                    <i class="fas fa-calendar-alt mr-2"></i> Agendar Cita
                </button>
            </div>
        </div>
    </section>

    <!-- Secci√≥n de Cursos con Im√°genes Actualizada -->
    <section id="courses" class="py-16 px-4 md:px-8 bg-blue-50">
        <h2 class="text-3xl font-bold text-center mb-12 text-gray-800">üéì Cursos de Inteligencia Artificial</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 max-w-6xl mx-auto">

            <!-- Curso 1: Introducci√≥n a la Inteligencia Artificial -->
            <div class="course-card bg-white rounded-lg shadow-xl hover:shadow-2xl transition duration-300 overflow-hidden">
                <!-- Imagen 1: ia3.jpg (Robot con chat bubbles) -->
                <img src="ia3.jpg" onerror="this.onerror=null; this.src='https://placehold.co/600x400/1e40af/ffffff?text=Introducci√≥n+a+IA';" alt="Introducci√≥n a la Inteligencia Artificial" class="w-full">
                <div class="p-5">
                    <i class="fas fa-brain text-4xl text-blue-600 mb-2"></i>
                    <h3 class="text-xl font-semibold mb-2">Introducci√≥n a la IA</h3>
                    <p class="text-gray-600 text-sm">Comprende los conceptos clave y el impacto de la Inteligencia Artificial en el mundo moderno.</p>
                    <a href="https://www.elementsofai.com/es/" target="_blank" 
                    class="block text-center mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 rounded-lg transition duration-300">
                        Ver Curso <i class="fas fa-arrow-right ml-2"></i>
                    </a>
                </div>
            </div>

            <!-- Curso 2: Fundamentos de Machine Learning -->
            <div class="course-card bg-white rounded-lg shadow-xl hover:shadow-2xl transition duration-300 overflow-hidden">
                <!-- Imagen 2: ia2.jpg (Rostro de robot con circuitos) -->
                <img src="ia2.jpg" onerror="this.onerror=null; this.src='https://placehold.co/600x400/8b5cf6/ffffff?text=Machine+Learning';" alt="Fundamentos de Machine Learning" class="w-full">
                <div class="p-5">
                    <i class="fas fa-robot text-4xl text-purple-600 mb-2"></i>
                    <h3 class="text-xl font-semibold mb-2">Fundamentos de ML</h3>
                    <p class="text-gray-600 text-sm">Explora los algoritmos y modelos de aprendizaje autom√°tico desde cero.</p>
                    <a href="https://developers.google.com/machine-learning?hl=es-419" target="_blank" 
                    class="block text-center mt-4 w-full bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 rounded-lg transition duration-300">
                        Ver Curso <i class="fas fa-arrow-right ml-2"></i>
                    </a>
                </div>
            </div>

            <!-- Curso 3: Chatbots con IA: C√≥mo funcionan -->
            <div class="course-card bg-white rounded-lg shadow-xl hover:shadow-2xl transition duration-300 overflow-hidden">
                <!-- Imagen 3: ia1.jpg (Robot beb√© con aud√≠fonos) -->
                <img src="ia1.jpg" onerror="this.onerror=null; this.src='https://placehold.co/600x400/f59e0b/ffffff?text=Chatbots';" alt="Chatbots con IA" class="w-full">
                <div class="p-5">
                    <i class="fas fa-comments text-4xl text-yellow-600 mb-2"></i>
                    <h3 class="text-xl font-semibold mb-2">Chatbots con IA</h3>
                    <p class="text-gray-600 text-sm">Aprende a dise√±ar, entrenar e implementar asistentes conversacionales inteligentes.</p>
                    <a href="https://cloud.google.com/use-cases/ai-chatbot?hl=es-419" target="_blank" 
                    class="block text-center mt-4 w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 rounded-lg transition duration-300">
                        Ver Curso <i class="fas fa-arrow-right ml-2"></i>
                    </a>
                </div>
            </div>

            <!-- Curso 4: Prompt Engineering B√°sica -->
            <div class="course-card bg-white rounded-lg shadow-xl hover:shadow-2xl transition duration-300 overflow-hidden">
                <!-- Imagen 4: ia4.jpg (Mano en laptop con √≠conos de IA) -->
                <img src="ia4.jpg" onerror="this.onerror=null; this.src='https://placehold.co/600x400/dc2626/ffffff?text=Prompt+Engineering';" alt="Prompt Engineering" class="w-full">
                <div class="p-5">
                    <i class="fas fa-keyboard text-4xl text-red-600 mb-2"></i>
                    <h3 class="text-xl font-semibold mb-2">Prompt Engineering</h3>
                    <p class="text-gray-600 text-sm">Domina el arte de comunicarte con la IA para obtener resultados precisos y creativos.</p>
                    <a href="https://grow.google/prompting-essentials/" target="_blank" 
                    class="block text-center mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-medium py-2 rounded-lg transition duration-300">
                        Ver Curso <i class="fas fa-arrow-right ml-2"></i>
                    </a>
                </div>
            </div>

        </div>
        
        <!-- Bot√≥n para Producci√≥n Audiovisual -->
        <div class="text-center mt-12">
            <button onclick="openModal('videoModal')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-10 rounded-full shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                <i class="fas fa-video mr-2"></i> Generar Video Resumen IA
            </button>
        </div>
    </section>

    <!-- Secci√≥n de Contacto R√°pido (Integraci√≥n Make) -->
    <section id="contact" class="py-16 px-4 md:px-8 bg-white">
        <div class="max-w-4xl mx-auto text-center p-8 rounded-xl shadow-2xl border-t-4 border-yellow-500">
            <h2 class="text-3xl font-bold mb-4 text-gray-800">‚úâÔ∏è ¬øTienes Preguntas? Cont√°ctanos</h2>
            <p class="text-gray-600 mb-6">Reg√≠strate en este formulario para recibir una asesor√≠a gratuita o una gu√≠a de inicio r√°pido por correo electr√≥nico. (Simulaci√≥n de conexi√≥n con **Make**).</p>
            
            <form id="registroForm" class="space-y-4">
                <div>
                    <input type="text" id="contact-name" name="name" placeholder="Tu Nombre" required class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                </div>
                <div>
                    <input type="email" id="contact-email" name="email" placeholder="Tu Correo Electr√≥nico" required class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                </div>
                <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 rounded-lg transition duration-300 transform hover:scale-[1.01]">
                    <i class="fas fa-envelope mr-2"></i> Recibir Gu√≠a Gratis por Email
                </button>
            </form>
            
            <!-- Mensaje de confirmaci√≥n del Webhook de Make -->
            <div id="formMessage" class="mt-4 p-3 rounded-lg text-center font-medium hidden"></div>
        </div>
    </section>

    <!-- Secci√≥n de Comunidad y Foro Global (NUEVO) -->
    <section id="community" class="py-16 px-4 md:px-8 bg-gray-100">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-12 text-gray-800"><i class="fas fa-users-line mr-2"></i> Comunidad de Aprendizaje (Foro Global)</h2>
            
            <div class="bg-white rounded-xl shadow-xl p-6">
                <h3 class="text-xl font-semibold mb-4 text-purple-700">Preguntas y Debates</h3>
                
                <!-- Contenedor de Mensajes del Foro -->
                <div id="forum-posts" class="space-y-4 overflow-y-auto h-96 p-2 mb-4 border border-gray-200 rounded-lg bg-gray-50">
                    <!-- Los mensajes del foro se cargar√°n aqu√≠ con onSnapshot -->
                    <p class="text-center text-gray-400 mt-16">Cargando mensajes del foro...</p>
                </div>

                <!-- Formulario para Nuevo Mensaje -->
                <form id="forum-form" onsubmit="submitForumPost(event)">
                    <textarea id="forum-input" rows="3" placeholder="Escribe tu pregunta o comentario para la comunidad..." required class="w-full border border-gray-300 rounded-lg p-3 resize-none focus:ring-purple-500 focus:border-purple-500"></textarea>
                    <div class="mt-3 flex justify-end">
                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-6 rounded-lg transition duration-300">
                            <i class="fas fa-comment-dots mr-2"></i> Publicar en el Foro
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>
    
    <!-- Bot√≥n Flotante del Asistente IA (AURA) -->
    <button id="aura-button" onclick="openModal('auraModal')" class="transition duration-300">
        <!-- NOTA: Se usa un placeholder para la imagen de AURA por ser un recurso externo -->
        <img src="https://placehold.co/70x70/6d28d9/ffffff?text=IA" alt="Asistente IA Tutor" title="Asistente IA Tutor AURA">
    </button>
    

    <!-- Pie de P√°gina (Footer) -->
    <footer class="bg-gray-800 text-white py-8 px-4 md:px-8">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center">
            <p class="mb-4 md:mb-0 text-gray-400">&copy; 2025 LEARNING TOGETHER. Todos los derechos reservados.</p>
            <div class="flex space-x-6">
                <a href="https://www.facebook.com/profile.php?id=61583437227107" class="text-gray-400 hover:text-blue-400 transition duration-300" aria-label="Facebook"><i class="fab fa-facebook-f text-xl"></i></a>
                <a href="https://x.com/ialearningtoget" class="text-gray-400 hover:text-blue-400 transition duration-300" aria-label="Twitter"><i class="fab fa-twitter text-xl"></i></a>
                <a href="https://www.linkedin.com/in/learning-together-05a3b1391/" class="text-gray-400 hover:text-blue-400 transition duration-300" aria-label="LinkedIn"><i class="fab fa-linkedin-in text-xl"></i></a>
                <a href="https://www.instagram.com/learningtogetheria/" class="text-gray-400 hover:text-blue-400 transition duration-300" aria-label="Instagram"><i class="fab fa-instagram text-xl"></i></a>
            </div>
        </div>
    </footer>


    <!-- Modal de Registro de Usuario -->
    <div id="registerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" onclick="closeModal(event, 'registerModal')">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4 text-blue-600">Registro de Usuario</h3>
            <p class="mb-4">Ingresa tus datos para empezar tu viaje con la IA.</p>
            <form id="registrationForm" onsubmit="handleFormSubmit(event, 'Registro', 'registerModal')">
                <div class="mb-4">
                    <label for="reg-name" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                    <input type="text" id="reg-name" name="name" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="reg-email" class="block text-sm font-medium text-gray-700">Correo Electr√≥nico</label>
                    <input type="email" id="reg-email" name="email" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                    <p id="email-error" class="text-sm text-red-600 mt-1 hidden">Por favor, introduce un correo v√°lido.</p>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal(null, 'registerModal')" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">
                        <i class="fas fa-paper-plane mr-2"></i> Enviar Registro
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Intereses Educativos -->
    <div id="interestsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" onclick="closeModal(event, 'interestsModal')">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4 text-blue-600">Selecciona tus Intereses</h3>
            <p class="mb-4">Ay√∫danos a recomendarte el mejor camino:</p>
            <div class="space-y-3">
                <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-blue-50">
                    <input type="checkbox" name="interest" value="IA Basica" class="form-checkbox text-blue-600 h-5 w-5 rounded focus:ring-blue-500">
                    <span class="text-gray-700 font-medium">Introducci√≥n a la Inteligencia Artificial</span>
                </label>
                <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-blue-50">
                    <input type="checkbox" name="interest" value="Machine Learning" class="form-checkbox text-blue-600 h-5 w-5 rounded focus:ring-blue-500">
                    <span class="text-gray-700 font-medium">Fundamentos de Machine Learning</span>
                </label>
                <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-blue-50">
                    <input type="checkbox" name="interest" value="Chatbots" class="form-checkbox text-blue-600 h-5 w-5 rounded focus:ring-blue-500">
                    <span class="text-gray-700 font-medium">Creaci√≥n de Chatbots con IA</span>
                </label>
                <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-blue-50">
                    <input type="checkbox" name="interest" value="Prompt Engineering" class="form-checkbox text-blue-600 h-5 w-5 rounded focus:ring-blue-500">
                    <span class="text-gray-700 font-medium">Prompt Engineering B√°sica</span>
                </label>
            </div>
            <div class="mt-6 flex justify-end">
                <button type="button" onclick="closeModal(null, 'interestsModal'); showNotification('Intereses guardados.', 'info')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">
                    <i class="fas fa-check mr-2"></i> Guardar y Continuar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Agendar Asesor√≠a (Simulaci√≥n Make) -->
    <div id="appointmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" onclick="closeModal(event, 'appointmentModal')">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4 text-green-600">Agendar Asesor√≠a Personalizada</h3>
            <p class="mb-4">Completa el formulario para recibir una confirmaci√≥n de cita (Simulaci√≥n de conexi√≥n con **Make**).</p>
            <form id="appointmentForm" onsubmit="handleFormSubmit(event, 'Cita', 'appointmentModal')">
                <div class="mb-4">
                    <label for="app-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                    <input type="text" id="app-name" name="name" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="mb-4">
                    <label for="app-email" class="block text-sm font-medium text-gray-700">Correo Electr√≥nico</label>
                    <input type="email" id="app-email" name="email" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="mb-4">
                    <label for="app-topic" class="block text-sm font-medium text-gray-700">Tema de Inter√©s</label>
                    <select id="app-topic" name="topic" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-green-500 focus:border-green-500">
                        <option value="">Selecciona un Tema</option>
                        <option value="Introduccion a IA">Introducci√≥n a IA</option>
                        <option value="Fundamentos ML">Fundamentos de ML</option>
                        <option value="Asistencia Chatbot">Asistencia con Chatbots</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="openConfirmationModal('appointmentForm')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-300">
                        <i class="fas fa-calendar-check mr-2"></i> Confirmar Cita
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal del Asistente IA Tutor (AURA) - ADAPTADO PARA GEMINI -->
    <div id="auraModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" onclick="closeModal(event, 'auraModal')">
        <div class="bg-white rounded-lg w-full max-w-lg shadow-2xl relative" onclick="event.stopPropagation()">
            <div class="p-4 border-b flex justify-between items-center bg-purple-600 rounded-t-lg text-white">
                <h3 class="text-xl font-bold"><i class="fas fa-chalkboard-teacher mr-2"></i> Asistente IA Tutor AURA</h3>
                <button onclick="closeModal(null, 'auraModal')" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>
            <div id="aura-modal-content" class="p-4 flex flex-col" style="height: 60vh;">
                <!-- Contenedor de Mensajes del Chat -->
                <div id="chat-messages" class="space-y-4 flex flex-col flex-grow overflow-y-auto">
                    <!-- Mensaje inicial de AURA -->
                    <div class="chat-message ai">
                        <p class="font-semibold text-purple-700 mb-1">AURA:</p>
                        <p>¬°Hola! Soy tu Asistente IA. Hazme cualquier pregunta sobre IA, Machine Learning, o Prompt Engineering.</p>
                    </div>
                </div>

                <!-- Indicador de Carga (Spinning Loader) -->
                <div id="chat-loading" class="text-center py-2 text-gray-500 hidden">
                    <div class="inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-purple-600"></div>
                    <span class="ml-2">AURA est√° pensando...</span>
                </div>
            </div>
            <div class="p-4 border-t">
                <div class="flex space-x-2">
                    <input type="text" id="user-input" placeholder="Escribe tu pregunta..." class="flex-grow border border-gray-300 rounded-full p-3 focus:ring-purple-500 focus:border-purple-500" onkeydown="if(event.key === 'Enter') sendMessage()">
                    <button onclick="sendMessage()" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-full transition duration-300" title="Enviar Mensaje">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <!-- Bot√≥n de Voz (Simulado) -->
                    <button id="voice-button" onclick="toggleVoiceInput()" class="bg-gray-400 hover:bg-gray-500 text-white p-3 rounded-full transition duration-300" title="Activar Micr√≥fono">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                <p id="voice-status" class="text-sm text-center text-gray-500 mt-2 hidden">Haz clic en el micr√≥fono para hablar.</p>
            </div>
        </div>
    </div>
    
    <!-- NUEVO Modal de Producci√≥n Audiovisual (Criterio 4) -->
    <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" onclick="closeModal(event, 'videoModal')">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4 text-indigo-600"><i class="fas fa-magic mr-2"></i> Producci√≥n Audiovisual IA</h3>
            <p class="mb-4 text-gray-700">Aqu√≠ puedes generar infograf√≠as, clips personalizados y tu video resumen final del curso utilizando nuestra IA.</p>
            
            <div class="space-y-4">
                
                <div class="border p-4 rounded-lg bg-indigo-50">
                    <label for="video-topic" class="block text-lg font-medium text-indigo-700 mb-2">Tema para el Video Resumen:</label>
                    <select id="video-topic" name="video-topic" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Selecciona el curso a resumir</option>
                        <option value="Introduccion a IA">Introducci√≥n a la IA (Resumen Final)</option>
                        <option value="Fundamentos ML">Fundamentos de ML (Resumen Final)</option>
                        <option value="Chatbots">Chatbots con IA (Resumen Final)</option>
                        <option value="Prompt Engineering">Prompt Engineering (Resumen Final)</option>
                    </select>
                </div>

                <button onclick="generateVideo()" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    <i class="fas fa-wand-magic-sparkles mr-2"></i> Generar Video Resumen IA
                </button>
                
                <!-- Dashboard Multimedia Simulado -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-xl font-semibold mb-2 text-gray-800">Dashboard Multimedia</h4>
                    <div id="multimedia-dashboard" class="space-y-2">
                        <div class="flex justify-between items-center p-2 bg-white rounded-lg shadow-sm">
                            <span><i class="fas fa-chart-pie text-blue-500 mr-2"></i> Infograf√≠a Personalizada:</span>
                            <span id="infografia-status" class="text-gray-500">No disponible</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-white rounded-lg shadow-sm">
                            <span><i class="fas fa-film text-green-500 mr-2"></i> Clips Explicativos (Total):</span>
                            <span id="clips-total" class="text-gray-500">0 clips</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-white rounded-lg shadow-sm">
                            <span><i class="fas fa-file-video text-pink-500 mr-2"></i> √öltimo Video Resumen:</span>
                            <span id="last-video-status" class="text-gray-500">Ninguno</span>
                        </div>
                    </div>
                </div>

            </div>
            
            <div class="mt-6 flex justify-end">
                <button type="button" onclick="closeModal(null, 'videoModal')" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-300">Cerrar</button>
            </div>
        </div>
    </div>


    <!-- Modal de Confirmaci√≥n Gen√©rico (Reemplazo de confirm()) -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" onclick="closeModal(event, 'confirmModal')">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-orange-600"><i class="fas fa-exclamation-triangle mr-2"></i> Confirmaci√≥n Requerida</h3>
            <p id="confirm-message" class="mb-6 text-gray-700">¬øEst√°s seguro de que quieres realizar esta acci√≥n cr√≠tica?</p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeModal(null, 'confirmModal')" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-300">Cancelar</button>
                <button id="confirm-action-button" type="button" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition duration-300">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificaci√≥n Gen√©rico (Reemplazo de alert()) -->
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" onclick="closeModal(event, 'notificationModal')">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-2xl relative" onclick="event.stopPropagation()">
            <div class="flex items-center mb-4">
                <i id="notification-icon" class="text-3xl mr-3"></i>
                <h3 id="notification-title" class="text-xl font-bold">Notificaci√≥n</h3>
            </div>
            <p id="notification-message" class="text-gray-700 mb-4"></p>
            <button type="button" 
                onclick="document.getElementById('notificationModal').classList.add('hidden'); document.getElementById('notificationModal').classList.remove('flex');" 
                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-300">
                Aceptar
            </button>
            </div>
    </div>

    <script type="module">
        // Importaciones de Firebase 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Importamos 'collection', 'addDoc', 'onSnapshot' y AHORA 'query' y 'orderBy' (para el foro)
        import { getFirestore, setLogLevel, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /**
         * PASO 0: Configuraci√≥n Local de Firebase (Solo si no est√° en Canvas)
         */
        // *** COMENTARIOS CLAROS: PEGA AQU√ç TU CONFIGURACI√ìN REAL DE FIREBASE ***
        const LOCAL_FIREBASE_CONFIG = { // <<<< CORRECCI√ìN: El nombre de la variable se corrige a LOCAL_FIREBASE_CONFIG
            apiKey: "AIzaSyAraXSa95EcF2zqsk-ZK9uVlZQ05VPu-Vk", // <--- DEBES PEGAR AQU√ç TU CLAVE REAL
            authDomain: "learning-together-aj.firebaseapp.com",
            projectId: "learning-together-aj",
            storageBucket: "learning-together-aj.firebasestorage.app",
            messagingSenderId: "1005231459765",
            appId: "1:1005231459765:web:5944be8ee172cd6b681dfc"
        }; 

        /**
         * PASO 1: Configuraci√≥n e Inicializaci√≥n de Firebase
         */
        
        // 1. Determinar la configuraci√≥n a usar: Canvas (con variables globales) o Local (con LOCAL_FIREBASE_CONFIG)
        let FIREBASE_CONFIG_TO_USE = {};
        let isRunningInCanvas = typeof __firebase_config !== 'undefined';

        if (isRunningInCanvas) {
            FIREBASE_CONFIG_TO_USE = JSON.parse(__firebase_config);
        } else {
            console.warn("[FIREBASE] Usando configuraci√≥n LOCAL. ¬°Aseg√∫rate de actualizar LOCAL_FIREBASE_CONFIG!");
            FIREBASE_CONFIG_TO_USE = LOCAL_FIREBASE_CONFIG; // <<<< CORRECCI√ìN: Ahora usa la constante con tus credenciales
        }

        // 2. Establecer IDs (el appId es el ID del Canvas, si no existe, usamos un ID gen√©rico)
        const localProjectId = FIREBASE_CONFIG_TO_USE.projectId;
        const appId = isRunningInCanvas ? __app_id : localProjectId;
        const initialAuthToken = isRunningInCanvas ? __initial_auth_token : null;
        
        // 3. Inicializar Firebase de forma segura
        let app = null;
        let auth = null;
        let db = null;
        let initializationError = false;

        // Comprobamos si tenemos una configuraci√≥n v√°lida (al menos el projectId que no sea el placeholder)
        if (FIREBASE_CONFIG_TO_USE && FIREBASE_CONFIG_TO_USE.projectId && FIREBASE_CONFIG_TO_USE.projectId !== "TU_PROJECT_ID") {
            try {
                app = initializeApp(FIREBASE_CONFIG_TO_USE);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); 
                console.log("[FIREBASE] Inicializaci√≥n de App y DB exitosa.");
            } catch(e) {
                console.error("[FIREBASE FATAL] Error al inicializar Firebase con la configuraci√≥n proporcionada. Revisa tus credenciales.", e);
                initializationError = true;
            }
        } else if (!isRunningInCanvas) {
            console.error("[FIREBASE FATAL] No se pudo inicializar Firebase. Debes actualizar la variable LOCAL_FIREBASE_CONFIG con tus credenciales. La funcionalidad de DB est√° deshabilitada.");
            initializationError = true;
        }


        let userId = null;
        let isAuthReady = false;

        async function authenticateUser() {
            if (initializationError) {
                // Si hubo un error en la inicializaci√≥n, no intentar autenticar.
                isAuthReady = true;
                return;
            }

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("[AUTH] Sesi√≥n iniciada con token personalizado.");
                } else {
                    await signInAnonymously(auth);
                    console.log("[AUTH] Sesi√≥n iniciada an√≥nimamente.");
                }
            } catch (error) {
                console.error("[AUTH ERROR] Error durante la autenticaci√≥n:", error);
                // Si la autenticaci√≥n falla, asumimos que no hay base de datos.
                isAuthReady = true; 
            }
        }
        
        // Funci√≥n para actualizar la interfaz del bot√≥n de registro
        function updateRegistrationButton(isRegistered) {
            const button = document.getElementById('registerButton');
            const modal = document.getElementById('registerModal');
            
            if (isRegistered) {
                // Si el usuario ya se registr√≥:
                button.textContent = '‚úÖ Ya Registrado';
                button.classList.add('btn-registered'); // Clase CSS especial
                button.onclick = () => showNotification('¬°Ya te has registrado! Bienvenido de vuelta.', 'info');
                // Ocultamos el modal de registro ya que no es necesario
                if (modal) modal.remove(); 
                console.log("[UX] Bot√≥n de registro actualizado: Ya Registrado.");
            } else {
                // Si el usuario NO se ha registrado:
                button.innerHTML = '<i class="fas fa-user-plus mr-2"></i> Reg√≠strate Ahora';
                button.classList.remove('btn-registered');
                button.onclick = () => openModal('registerModal');
                console.log("[UX] Bot√≥n de registro disponible.");
            }
        }

        // ----------------------------------------------------------------------
        // ** PARTES 3 & 4: L√≥gica de Lectura en Tiempo Real y Dashboard **
        // ----------------------------------------------------------------------
        
        /**
         * üîÑ Actualiza el dashboard del usuario con los datos de Firebase.
         * @param {number} appointmentCount - N√∫mero total de citas agendadas.
         */
        function updateDashboard(appointmentCount) {
            const dashboard = document.getElementById('user-dashboard');
            const pointsEl = document.getElementById('dashboard-points');
            const appointmentsEl = document.getElementById('dashboard-appointments');
            
            // L√≥gica de Gamificaci√≥n: Puntos (Simulaci√≥n)
            // Asignamos 10 puntos por cada cita agendada
            const totalPoints = appointmentCount * 10; 

            if (dashboard) {
                // Si el usuario est√° autenticado, mostramos el dashboard
                dashboard.classList.remove('hidden');
                pointsEl.textContent = totalPoints;
                appointmentsEl.textContent = appointmentCount;
                
                // L√≥gica de niveles (Simulaci√≥n):
                let levelMessage = '';
                if (totalPoints >= 30) {
                    levelMessage = '¬°Gran Colaborador! Eres Nivel Experto. üöÄ';
                } else if (totalPoints >= 10) {
                    levelMessage = '¬°Estudiante Proactivo! Eres Nivel Intermedio. üëç';
                }
                
                document.getElementById('welcome-message').innerHTML = `<i class="fas fa-gem mr-2"></i> ${levelMessage || '¬°Bienvenido! Tu progreso cuenta.'}`;
            }
        }
        
        /**
         * üîÑ Actualiza el dashboard multimedia con datos simulados.
         * @param {string} videoStatus - Estado del √∫ltimo video generado.
         */
        function updateMultimediaDashboard(videoStatus) {
            const infografiaStatus = document.getElementById('infografia-status');
            const clipsTotal = document.getElementById('clips-total');
            const lastVideoStatus = document.getElementById('last-video-status');
            
            // Simulaci√≥n de datos de progreso
            const clips = 5; // Simulaci√≥n: 5 clips generados autom√°ticamente
            
            infografiaStatus.textContent = 'Generada (Ver Aqu√≠)';
            infografiaStatus.classList.remove('text-gray-500');
            infografiaStatus.classList.add('text-green-600', 'font-semibold');
            
            clipsTotal.textContent = `${clips} clips`;
            
            if (videoStatus) {
                 lastVideoStatus.textContent = videoStatus;
                 lastVideoStatus.classList.add('text-pink-600', 'font-semibold');
            }
        }
        
        /**
         * üîÑ Renderiza los mensajes del foro.
         * @param {Array<Object>} posts - Lista de documentos de posts.
         */
        function renderForumPosts(posts) {
            const container = document.getElementById('forum-posts');
            container.innerHTML = ''; // Limpiar mensajes anteriores
            
            if (posts.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 mt-16">S√© el primero en publicar una pregunta o un comentario.</p>';
                return;
            }

            // Ordenar por fecha (m√°s nuevo primero) antes de renderizar (ya que el query lo hace, esto es por si acaso)
            posts.sort((a, b) => b.timestamp - a.timestamp); 
            
            posts.forEach(post => {
                const date = post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' }) : 'Fecha desconocida';
                
                const postDiv = document.createElement('div');
                postDiv.className = 'p-3 border-b border-gray-100 last:border-b-0';
                postDiv.innerHTML = `
                    <div class="flex items-center text-sm mb-1">
                        <i class="fas fa-user-circle text-blue-500 mr-2"></i>
                        <span class="font-semibold text-gray-700">${post.userName || 'Usuario An√≥nimo'}</span>
                        <span class="text-gray-400 ml-3 text-xs">${date}</span>
                    </div>
                    <p class="text-gray-800 ml-6 whitespace-pre-wrap">${post.message}</p>
                `;
                container.appendChild(postDiv);
            });
            
            // Desplazar al final para ver el mensaje m√°s reciente
            container.scrollTop = container.scrollHeight; 
        }

        /**
         * üéß Configura los listeners de datos para el usuario actual.
         */
        function setupDataListeners() {
            if (initializationError || !db || !userId) {
                 console.warn("[FIRESTORE] Listener de datos deshabilitado. Revisa la configuraci√≥n de Firebase.");
                 document.getElementById('forum-posts').innerHTML = '<p class="text-center text-red-500 mt-16">El foro est√° deshabilitado. Error de conexi√≥n con Firebase.</p>';
                return;
            }
            
            const currentUserId = userId;
            const currentAppId = appId;
            
            // Listener 1: Registros (Para actualizar el bot√≥n de registro)
            // COMENTARIOS CLAROS: Usamos una subcolecci√≥n privada 'registrations' para cada usuario
            const regPath = `artifacts/${currentAppId}/users/${currentUserId}/registrations`;
            onSnapshot(collection(db, regPath), (snapshot) => {
                const registrationsCount = snapshot.docs.length; 
                updateRegistrationButton(registrationsCount > 0);
                console.log(`[FIRESTORE] Registrations: ${registrationsCount} documents.`);
            }, (error) => {
                console.error("[FIRESTORE ERROR] Error en registrations listener:", error);
            });
            
            // Listener 2: Citas (Para actualizar el dashboard de Gamificaci√≥n)
            // COMENTARIOS CLAROS: Usamos una subcolecci√≥n privada 'appointments' para cada usuario
            const apptPath = `artifacts/${currentAppId}/users/${currentUserId}/appointments`;
            onSnapshot(collection(db, apptPath), (snapshot) => {
                const appointmentCount = snapshot.docs.length;
                updateDashboard(appointmentCount);
                console.log(`[FIRESTORE] Appointments: ${appointmentCount} documents.`);
            }, (error) => {
                console.error("[FIRESTORE ERROR] Error en appointments listener:", error);
            });
            
            // Listener 3 (NUEVO): Foro Global (Colecci√≥n P√∫blica)
            // COMENTARIOS CLAROS: Usamos una colecci√≥n p√∫blica 'forum_posts'
            const forumPath = `artifacts/${currentAppId}/public/data/forum_posts`;
            
            // Creamos un Query para ordenar los posts por fecha (descendente)
            // NOTA: 'timestamp' es el campo que se guarda en el addDoc (ver submitForumPost)
            const forumQuery = query(collection(db, forumPath), orderBy('timestamp', 'desc'), limit(50));
            
            onSnapshot(forumQuery, (snapshot) => {
                const posts = [];
                snapshot.forEach(doc => {
                    posts.push({ id: doc.id, ...doc.data() });
                });
                renderForumPosts(posts.reverse()); // Invertir para mostrar el m√°s nuevo al final de la ventana
                console.log(`[FIRESTORE] Forum Posts: ${posts.length} documents.`);
            }, (error) => {
                console.error("[FIRESTORE ERROR] Error en forum listener:", error);
                document.getElementById('forum-posts').innerHTML = '<p class="text-center text-red-500 mt-16">Error al cargar el foro. Verifica las reglas de seguridad de Firebase.</p>';
            });
            
            // Simulaci√≥n de Dashboard Multimedia: Actualizar al inicio
            updateMultimediaDashboard(null);
        }
        
        // Listener de Autenticaci√≥n (Se asegura de que setupDataListeners se llame con el userId correcto)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                console.log(`[AUTH] Usuario autenticado. UID: ${userId}`);
                
                setupDataListeners();
            } else {
                // Generar un UID temporal para usuarios no autenticados (usado en entorno local sin token)
                userId = crypto.randomUUID(); 
                console.log("[AUTH] Usuario desautenticado/An√≥nimo. UID temporal:", userId);
                updateRegistrationButton(false); 
                document.getElementById('user-dashboard').classList.add('hidden'); 
            }
            isAuthReady = true;
            
            const footer = document.querySelector('footer');
            if (footer && userId) {
                let userIdDisplay = document.getElementById('userIdDisplay');
                if (!userIdDisplay) {
                    userIdDisplay = document.createElement('p');
                    userIdDisplay.id = 'userIdDisplay';
                    userIdDisplay.className = 'text-xs mt-2 text-gray-500';
                    footer.prepend(userIdDisplay);
                }
                // COMENTARIOS CLAROS: Mostrar el ID completo es obligatorio para depuraci√≥n y multi-usuario
                userIdDisplay.textContent = `ID de Usuario (UID): ${userId}`;
            }
        });

        authenticateUser();

        // üö® CORRECCI√ìN: Exportar funciones para que el HTML pueda acceder a ellas.
        window.db = db; 
        window.getUserId = () => userId; 
        window.getAppId = () => appId; 
        window.isAuthReady = () => isAuthReady; 
        
        // ** EXPORTACI√ìN DE FUNCIONES FALTANTES **
        window.generateVideo = generateVideo;
        window.submitForumPost = submitForumPost;
        window.showNotification = showNotification; // Asegurar que el HTML pueda llamar a las notificaciones
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.openConfirmationModal = openConfirmationModal; // Necesaria para el formulario de cita
        window.handleFormSubmit = handleFormSubmit; // Necesaria para el registro y cita
        window.sendMessage = sendMessage;
        window.toggleVoiceInput = toggleVoiceInput;
        
        // --- COMIENZA LA L√ìGICA JAVASCRIPT COM√öN ---
        
        const formToSubmit = { id: null };

        // Funci√≥n para mostrar el modal gen√©rico de notificaci√≥n (Reemplaza alert())
        function showNotification(message, type = 'success') {
            const modal = document.getElementById('notificationModal');
            const icon = document.getElementById('notification-icon');
            const title = document.getElementById('notification-title');
            const messageEl = document.getElementById('notification-message');
            
            icon.className = ''; 

            switch (type) {
                case 'success':
                    icon.classList.add('fas', 'fa-check-circle', 'text-green-500');
                    title.textContent = '¬°√âxito!';
                    title.classList.remove('text-red-600', 'text-yellow-600', 'text-blue-600');
                    title.classList.add('text-green-600');
                    break;
                case 'error':
                    icon.classList.add('fas', 'fa-times-circle', 'text-red-500');
                    title.textContent = 'Error';
                    title.classList.remove('text-green-600', 'text-yellow-600', 'text-blue-600');
                    title.classList.add('text-red-600');
                    break;
                case 'warning':
                    icon.classList.add('fas', 'fa-exclamation-triangle', 'text-yellow-500');
                    title.textContent = 'Advertencia';
                    title.classList.remove('text-green-600', 'text-red-600', 'text-blue-600');
                    title.classList.add('text-yellow-600');
                    break;
                case 'info':
                default:
                    icon.classList.add('fas', 'fa-info-circle', 'text-blue-500');
                    title.textContent = 'Informaci√≥n';
                    title.classList.remove('text-green-600', 'text-red-600', 'text-yellow-600');
                    title.classList.add('text-blue-600');
                    break;
            }

            messageEl.textContent = message;
            openModal('notificationModal');
        }

        // Funci√≥n para abrir cualquier modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        // Funci√≥n para cerrar cualquier modal
        function closeModal(event, modalId) {
            // CORRECCI√ìN CR√çTICA: Se corrige la l√≥gica para cerrar el modal correctamente.
            if (!event || (event.target && event.target.id === modalId)) { 
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            }
        }

        // Funci√≥n para abrir el modal de confirmaci√≥n (Reemplaza confirm())
        function openConfirmationModal(formId) {
            const form = document.getElementById(formId);
            const emailInput = form.querySelector('input[type="email"]');
            
            // Validar email antes de confirmar
            if (!validateEmail(emailInput.value)) {
                showNotification('Por favor, introduce un correo electr√≥nico v√°lido antes de confirmar.', 'error');
                emailInput.focus();
                return;
            }

            // Guardar el formulario para el env√≠o posterior
            formToSubmit.id = formId; 
            
            const confirmModal = document.getElementById('confirmModal');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmButton = document.getElementById('confirm-action-button');

            confirmMessage.textContent = `Est√°s a punto de confirmar tu cita de asesor√≠a. ¬øDeseas continuar con el env√≠o de tus datos?`;
            
            // Asignar el evento al bot√≥n de confirmaci√≥n
            confirmButton.onclick = function() {
                closeModal(null, 'confirmModal');
                // Llamar a la funci√≥n de env√≠o de formulario real
                document.getElementById(formToSubmit.id).dispatchEvent(new Event('submit', { cancelable: true }));
            };

            openModal('confirmModal');
        }

        // Funci√≥n de Validaci√≥n de Email
        function validateEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // Funci√≥n de Env√≠o de Formulario (Usa addDoc de la Parte 2)
        async function handleFormSubmit(event, formType, modalId) {
            event.preventDefault();

            // 1. Verificaci√≥n Inicial de Autenticaci√≥n
            if (!window.isAuthReady() || !window.getUserId()) {
                showNotification('El sistema de base de datos a√∫n se est√° cargando. Por favor, espera un momento y vuelve a intentarlo. (Revisa tu configuraci√≥n local de Firebase si usas VS Code)', 'warning');
                return;
            }

            // 1.1 Verificaci√≥n de Conexi√≥n a DB
            if (initializationError || !db) {
                showNotification('¬°La base de datos est√° desconectada! Revisa si actualizaste la variable LOCAL_FIREBASE_CONFIG en el c√≥digo.', 'error');
                return;
            }

            const currentUserId = window.getUserId();
            const currentAppId = window.getAppId();
            const form = event.target;
            
            // 2. Recolecci√≥n de Datos
            const name = form.querySelector('input[name="name"]').value;
            const email = form.querySelector('input[name="email"]').value;
            let topic = '';

            // Validaci√≥n de Email (la misma que ten√≠as, pero ahora clave para la BD)
            if (!validateEmail(email)) {
                showNotification('Por favor, introduce un correo electr√≥nico v√°lido antes de enviar.', 'error');
                return;
            }

            // Determinar la colecci√≥n y los datos a guardar
            let collectionName;
            let dataToSave = {
                name: name,
                email: email,
                timestamp: new Date() 
            };

            if (formType === 'Registro') {
                collectionName = 'registrations'; 
            } else if (formType === 'Cita') {
                collectionName = 'appointments'; 
                topic = form.querySelector('select[name="topic"]').value;
                dataToSave.topic = topic;
                dataToSave.status = 'Pending (Via Make Simulation)';
            } else {
                console.error(`Tipo de formulario desconocido: ${formType}`);
                return;
            }

            // 3. Creaci√≥n de la Ruta y Guardado en Firestore
            try {
                // **Ruta Segura y Privada en Firestore:** // /artifacts/{appId}/users/{userId}/[collectionName]
                const collectionPath = `artifacts/${currentAppId}/users/${currentUserId}/${collectionName}`;
                
                const collectionRef = collection(db, collectionPath);

                await addDoc(collectionRef, dataToSave);

                console.log(`[FIRESTORE] Documento de ${formType} guardado con √©xito en: ${collectionPath}`);
                
                // 4. Notificaci√≥n de √âxito y Limpieza
                showNotification(`¬°${formType} enviado y guardado! Tus datos ya est√°n seguros.`, 'success');
                
                document.getElementById(modalId).classList.add('hidden'); 
                document.getElementById(modalId).classList.remove('flex');
                form.reset(); // Intenta el reset

            } catch (e) {
                console.error("[FIRESTORE ERROR] Error al guardar el documento: ", e);
                showNotification(`Hubo un error al guardar tus datos. (Verifica las reglas de seguridad de Firebase)`, 'error');
            }
        }
        
        /**
         * üì£ Funci√≥n para enviar un nuevo mensaje al foro p√∫blico.
         */
        async function submitForumPost(event) {
            event.preventDefault();
            
            const inputElement = document.getElementById('forum-input');
            const message = inputElement.value.trim();
            
            if (message.length < 5) {
                showNotification('Tu mensaje es demasiado corto. Por favor, escribe un comentario o pregunta m√°s detallada.', 'warning');
                return;
            }
            
            if (!window.isAuthReady() || !window.getUserId()) {
                showNotification('La autenticaci√≥n se est√° cargando. Por favor, espera un momento antes de publicar. (Revisa tu configuraci√≥n local de Firebase si usas VS Code)', 'warning');
                return;
            }
            
            // 1.1 Verificaci√≥n de Conexi√≥n a DB
            if (initializationError || !db) {
                showNotification('¬°La base de datos est√° desconectada! Revisa si actualizaste la variable LOCAL_FIREBASE_CONFIG en el c√≥digo.', 'error');
                return;
            }


            // Simulaci√≥n de nombre de usuario: usar el UID para la identidad
            const userName = 'User-' + window.getUserId().substring(0, 8); 
            
            const dataToSave = {
                userName: userName,
                message: message,
                timestamp: new Date(),
                userId: window.getUserId()
            };
            
            // 4. Creaci√≥n de la Ruta y Guardado en Firestore (Ruta P√öBLICA)
            // /artifacts/{appId}/public/data/forum_posts
            const forumPath = `artifacts/${window.getAppId()}/public/data/forum_posts`;
            
            try {
                await addDoc(collection(db, forumPath), dataToSave);
                console.log("[FIRESTORE] Mensaje publicado en el foro global.");
                inputElement.value = ''; // Limpiar el input
            } catch (e) {
                console.error("[FIRESTORE ERROR] Error al publicar en el foro: ", e);
                showNotification(`Hubo un error al publicar el mensaje. (Verifica las reglas de seguridad de Firebase)`, 'error');
            }
        }


        /**
         * Simula la generaci√≥n de un video resumen por IA (Criterio 4).
         */
        function generateVideo() {
            const topic = document.getElementById('video-topic').value;
            
            if (!topic) {
                showNotification('Por favor, selecciona un curso para generar el video resumen.', 'warning');
                return;
            }
            
            showNotification(`Generando Video Resumen para: **${topic}**... Esto tardar√° unos segundos (Simulaci√≥n de IA).`, 'info');
            
            // Simulaci√≥n de tiempo de procesamiento de IA
            setTimeout(() => {
                showNotification(`‚úÖ Video Resumen de ${topic} COMPLETADO. Ya puedes descargarlo.`, 'success');
                
                // Actualiza el Dashboard Multimedia (Simulaci√≥n de estado guardado)
                updateMultimediaDashboard(`Descargar Video (${topic})`);
                
            }, 3000); // 3 segundos para simular la generaci√≥n
        }

        // ----------------------------------------------------------------------
        // ** INTEGRACI√ìN DEL AGENTE DE IA (GEMINI) - COMIENZA AQU√ç **
        // ----------------------------------------------------------------------

        // --- Configuraci√≥n de la API de Gemini ---
        // COMENTARIOS CLAROS: La clave aqu√≠ (GEMINI_API_KEY) es S√ìLO para un fallback. 
        // La clave SECRETA debe estar en tu servidor de Render/Node.js.
        const GEMINI_API_KEY = "AIzaSyDrcF6h60Y32LdTBQbQ6rl9Ro5fYhMJx6A"; // Clave gen√©rica/simulada
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        // URL del Servidor Proxy seguro (Node.js/Render)
        // *** COMENTARIOS CLAROS: PEGA LA URL DE TU SERVIDOR PROXY REAL AQU√ç ***
        const PROXY_API_URL = "https://learningtogether-e1qc.onrender.com/api/chat";

        // Instrucci√≥n de Sistema: Define el rol de AURA
        const GEMINI_SYSTEM_PROMPT = "Eres AURA, un tutor experto en Inteligencia Artificial, Machine Learning y Prompt Engineering. Responde las preguntas del estudiante de forma clara, amigable y concisa. Si te piden un 'quiz', genera tres preguntas de opci√≥n m√∫ltiple relacionadas con el tema y sus respuestas. Si la pregunta no est√° relacionada con IA, amablemente redirige la conversaci√≥n a esos temas.";


        /**
        * Llama al Servidor Proxy seguro para obtener la respuesta de Gemini.
        * @param {string} prompt - La consulta del usuario.
        * @param {number} retries - N√∫mero de reintentos restantes.
        * @param {number} delay - Retraso actual antes del reintento.
        * @returns {Promise<string>} La respuesta del modelo o un mensaje de error.
        */
        async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
            const chatLoading = document.getElementById('chat-loading');
            const sendButton = document.querySelector('#auraModal button[title="Enviar Mensaje"]');
            const userInput = document.getElementById('user-input');

            if (chatLoading) chatLoading.classList.remove('hidden');
            if (sendButton) sendButton.disabled = true;
            if (userInput) userInput.disabled = true;
    
            // 1. El payload es simple: enviamos el prompt y el system prompt al proxy
            const payload = {
                prompt: prompt,
                systemInstruction: GEMINI_SYSTEM_PROMPT
            };

            // COMENTARIOS CLAROS: Verifica la URL del proxy para detectar fallas de conexi√≥n
            if (PROXY_API_URL.includes("onrender.com") && PROXY_API_URL === "https://learningtogether-e1qc.onrender.com/api/chat") {
                console.warn("[AURA] Usando URL de proxy de prueba. Aseg√∫rate de que tu servidor est√© activo.");
            }

            try {
                // 2. Llamada al Servidor Proxy (PROXY_API_URL)
                const response = await fetch(PROXY_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Si hay un error (ej: 404 o 500 del servidor proxy)
                    const errorResult = await response.json().catch(() => ({ error: 'No se pudo parsear el error.' }));
                    throw new Error(`Error en el Proxy: ${errorResult.error || response.statusText}`);
                }

                // 3. El proxy nos devuelve un objeto simple: { text: "..." }
                const result = await response.json();
                
                if (result.text) {
                    return result.text; // Retorna el texto de la IA directamente
                } else {
                    throw new Error("Respuesta del proxy inv√°lida o incompleta.");
                }
            } catch (error) {
                console.error("Error en callGeminiAPI:", error);
                if (retries > 0) {
                    // Implementaci√≥n de Backoff Exponencial
                    await new Promise(res => setTimeout(res, delay));
                    return callGeminiAPI(prompt, retries - 1, delay * 2);
                } else {
                    return "Lo siento, estoy teniendo problemas de conexi√≥n con el servidor de IA. Por favor, intenta de nuevo m√°s tarde o verifica que tu servidor proxy Node.js est√© corriendo en: " + PROXY_API_URL;
                }
            } finally {
                // Asegurar que el estado del chat se restablezca
                if (chatLoading) chatLoading.classList.add('hidden');
                if (sendButton) sendButton.disabled = false;
                if (userInput) userInput.disabled = false;
            }
        }


        /**
         * Agrega un mensaje a la ventana de chat y maneja el scroll.
         * @param {string} message - El texto del mensaje.
         * @param {'user'|'ai'} sender - Qui√©n envi√≥ el mensaje.
         */
        function addMessage(message, sender) {
            const chatMessages = document.getElementById('chat-messages');
            
            const bubble = document.createElement('div');
            // Usamos las clases de estilo definidas en el <style>
            bubble.classList.add('chat-message', sender, 'my-2', 'p-3', 'shadow-md'); 

            if (sender === 'ai') {
                // Para AURA, incluimos el nombre del tutor
                bubble.innerHTML = `<p class="font-semibold text-purple-700 mb-1">AURA:</p><p style="white-space: pre-wrap;">${message}</p>`;
            } else {
                // Para el usuario
                bubble.innerHTML = `<p style="white-space: pre-wrap;">${message}</p>`;
            }
            
            chatMessages.appendChild(bubble);
            // Desplaza al final para ver el mensaje m√°s reciente
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }


        /**
         * L√≥gica principal del chatbot AURA, ahora usando Gemini.
         */
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (message === "") return;

            input.value = ''; 
            
            // 1. Mostrar mensaje del usuario
            addMessage(message, 'user');
            
            // 2. Llamar a la API de Gemini (con indicador de carga)
            const aiResponse = await callGeminiAPI(message);
            
            // 3. Mostrar respuesta de AURA
            addMessage(aiResponse, 'ai');
        }


        // ----------------------------------------------------------------------
        // ** PARTE 5: Mejoras del Chatbot AURA y Voz (TTS/STT Simulado) **
        // ----------------------------------------------------------------------
        
        let isListening = false;
        
        /**
         * Simula la activaci√≥n/desactivaci√≥n de la entrada de voz (Speech-to-Text).
         */
        function toggleVoiceInput() {
            const button = document.getElementById('voice-button');
            const statusEl = document.getElementById('voice-status');
            
            isListening = !isListening;
            
            if (isListening) {
                // Estado: Activado (Simulaci√≥n)
                button.classList.remove('bg-gray-400', 'hover:bg-gray-500');
                button.classList.add('bg-red-500', 'animate-pulse'); // Usamos rojo para indicar grabaci√≥n/activo
                statusEl.textContent = 'üé§ Escuchando... ¬°Dime tu pregunta!';
                statusEl.classList.remove('hidden');
                
                // Simulaci√≥n: Detener autom√°ticamente despu√©s de 4 segundos
                setTimeout(() => {
                    if (isListening) {
                        // En lugar de un mensaje fijo, podr√≠amos simular un mensaje que active un caso de uso
                        const simulatedVoiceQuery = "Expl√≠came qu√© es la ingenier√≠a de prompts";; 
                        simulateVoiceInput(simulatedVoiceQuery); // Simulaci√≥n de lo que el usuario dijo
                        toggleVoiceInput(); // Desactivar
                    }
                }, 4000); 

            } else {
                // Estado: Desactivado
                button.classList.remove('bg-red-500', 'animate-pulse');
                button.classList.add('bg-gray-400', 'hover:bg-gray-500');
                statusEl.textContent = 'Voz inactiva. Haz clic para activar.';
                statusEl.classList.add('hidden');
            }
        }

        /**
         * Simula la inserci√≥n de texto por voz en el campo de entrada.
         */
        function simulateVoiceInput(text) { 
             const input = document.getElementById('user-input');
             input.value = text;
             sendMessage(); 
        }

        // ----------------------------------------------------------------------
        // ** INTEGRACI√ìN DE MAKE (WEBHOOK) - COMIENZA AQU√ç **
        // ----------------------------------------------------------------------

        // Nota: El formulario de registro del Hero usa handleFormSubmit (Firebase) para el perfil. 
        // Este formulario de contacto r√°pido (registroForm) usa el Webhook de Make para la simulaci√≥n del email.
        
        const contactForm = document.getElementById('registroForm');
        const formMessage = document.getElementById('formMessage');

        // URL del Webhook de Make (Punto Final/Endpoint)
        // *** COMENTARIOS CLAROS: PEGA LA URL REAL DE TU SCENARIO DE MAKE AQU√ç ***
        const MAKE_WEBHOOK_URL = 'https://hook.us2.make.com/9dv6cpiio76f9epg5q85coh7malkn6dp'; 
        
        // Funci√≥n de Validaci√≥n de Email (para usar en la validaci√≥n de Make)
        function validateEmailMake(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        if (contactForm && formMessage) {
            contactForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(contactForm);
                const data = Object.fromEntries(formData.entries());
                
                // Validaci√≥n del Email antes de enviar a Make
                if (!validateEmailMake(data.email)) {
                    showNotification('Por favor, introduce un correo electr√≥nico v√°lido en el formulario de contacto.', 'error');
                    return;
                }
                
                // Mostrar mensaje de env√≠o
                formMessage.classList.remove('hidden');
                formMessage.textContent = 'Enviando tu solicitud a Make...';
                formMessage.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
                formMessage.style.color = '#333';


                // ** COMENTARIOS CLAROS: Si el usuario NO ha pegado su URL real, ejecutamos la SIMULACI√ìN. **
                if (MAKE_WEBHOOK_URL.includes('PEGA_AQUI_LA_URL_DE_TU_WEBHOOK_DE_MAKE')) {
                    // Si el usuario olvid√≥ pegar la URL, mostramos un mensaje de advertencia y simulamos el √©xito.
                    setTimeout(() => {
                        formMessage.textContent = '‚ö†Ô∏è ¬°AVISO! La URL de Make no est√° actualizada. El proceso real se SIMULA como exitoso.';
                        formMessage.style.backgroundColor = '#fff3cd'; // Amarillo claro
                        formMessage.style.color = '#856404'; // Texto marr√≥n
                        contactForm.reset();
                    }, 1500);
                    return;
                }


                try {
                    // Env√≠o de los datos al Webhook de Make (POST Request)
                    const response = await fetch(MAKE_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data) // Env√≠a los datos del formulario como JSON
                    });

                    if (response.ok) {
                        // √âxito: Make devuelve un status 200/202 si se recibe correctamente
                        formMessage.textContent = '‚úÖ ¬°Solicitud Enviada! Revisa tu correo, Make activ√≥ la automatizaci√≥n.';
                        formMessage.style.backgroundColor = '#d4edda'; // Color verde claro
                        formMessage.style.color = '#155724'; // Color de texto verde oscuro
                        contactForm.reset(); // Limpia el formulario
                    } else {
                        // Error al recibir en Make (posiblemente un error de URL o en Make)
                        const errorText = await response.text();
                        throw new Error(`Error al conectar con Make: ${response.status} - ${errorText}`);
                    }

                } catch (error) {
                    console.error('Error al enviar el formulario a Make:', error);
                    formMessage.textContent = '‚ùå Error en la automatizaci√≥n. Verifica la URL de tu Webhook de Make y las reglas de tu escenario.';
                    formMessage.style.backgroundColor = '#f8d7da'; // Color rojo claro
                    formMessage.style.color = '#721c24'; // Color de texto rojo oscuro
                }
            });
        }
        // --- FIN DE LA L√ìGICA MAKE ---

    </script>
</body>
</html>
